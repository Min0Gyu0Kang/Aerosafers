<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>LRI ì—”ì§„ í”„ë¡œí† íƒ€ì… ë°ëª¨</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; margin: 0; display: flex; height: 100vh; }
        #left-panel { width: 350px; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; }
        #map-container { flex-grow: 1; height: 100%; }
        #map-area { width: 100%; height: 100%; background-color: #e0e0e0; border: none; }
        #result-box { margin-top: 20px; padding: 15px; border: 2px solid #ccc; white-space: pre-wrap; background-color: #f9f9f9; }
        h2, h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"] { width: calc(100% - 10px); padding: 5px; margin-top: 5px; }
        button { width: 100%; padding: 10px; margin-top: 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        .grade-tag { padding: 5px; border-radius: 4px; font-weight: bold; color: black; }
        .grade-red { background-color: #ff6961; } /* Pastel Red */
        .grade-yellow { background-color: #fdfd96; } /* Pastel Yellow */
        .grade-blue { background-color: #aec6cf; } /* Pastel Blue */
        .grade-green { background-color: #77dd77; } /* Pastel Green */
        .hard-stop { border: 3px solid black; animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="left-panel">
        <h2>âœˆï¸ LRI ë¶„ì„ ì—”ì§„</h2>
        
        <div id="input-section">
            <h3>ì…ë ¥ íŒŒë¼ë¯¸í„°</h3>
            <label for="lat-input">ìœ„ë„</label>
            <input type="text" id="lat-input" placeholder="ì˜ˆ: 37.5665">

            <label for="lon-input">ê²½ë„</label>
            <input type="text" id="lon-input" placeholder="ì˜ˆ: 126.9780">

            <label for="uam-type">ë¹„í–‰ì²´ ì¢…ë¥˜</label>
            <select id="uam-type" style="width: 100%;">
                <option value="CTOL">CTOL</option>
                <option value="STOL">STOL</option>
                <option value="VTOL">VTOL</option>
                <option value="eVTOL" selected>eVTOL</option>
                <option value="eCTOL">eCTOL</option>
                <option value="eSTOL">eSTOL</option>
            </select>

            <label for="wing-type">ë¹„í–‰ ê¸°ì²´ êµ¬ë¶„</label>
            <select id="wing-type" style="width: 100%;">
                <option value="fixed">ê³ ì •ìµ</option>
                <option value="rotary" selected>íšŒì „ìµ</option>
            </select>

            <button id="submit-coords">ë¶„ì„ ì‹¤í–‰</button>
        </div>

        <div id="result-box">
            <!-- ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
            <p>ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ì¢Œí‘œë¥¼ ì…ë ¥ í›„ 'ë¶„ì„ ì‹¤í–‰'ì„ ëˆ„ë¥´ì„¸ìš”.</p>
        </div>
    </div>

    <div id="map-container">
        <iframe id="map-area" title="Interactive Map"></iframe>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Use the current page origin so calls go to the same origin (nginx will proxy /api/)
        // const API_BASE_URL = window.location.origin;
        // For local-only testing you can override with: 
        const API_BASE_URL = 'http://127.0.0.1:8000';
        // -------------------

        const latInput = document.getElementById('lat-input');
        const lonInput = document.getElementById('lon-input');
        const submitButton = document.getElementById('submit-coords');
        const resultBox = document.getElementById('result-box');
        const mapFrame = document.getElementById("map-area");
        const uamTypeSelect = document.getElementById('uam-type');
        const wingTypeSelect = document.getElementById('wing-type');

        let mapReady = false;
        let currentLat = null;
        let currentLon = null;
        let currentLri = null;

        // 1. ì¢Œí‘œ ì…ë ¥ í›„ ë¶„ì„ ìš”ì²­
        submitButton.addEventListener('click', () => {
            const lat = parseFloat(latInput.value);
            const lon = parseFloat(lonInput.value);

            if (!isNaN(lat) && !isNaN(lon)) {
                currentLat = lat;
                currentLon = lon;
                requestLriAnalysis(lat, lon);
            } else {
                alert('ìœ íš¨í•œ ìœ„ë„ì™€ ê²½ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            }
        });

        // 2. ë§ˆì»¤ í‘œì‹œ: ì§€ë„ iframeì—ì„œ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ì—¬ ì¢Œí‘œë¥¼ ì—…ë°ì´íŠ¸
        window.addEventListener('message', (event) => {
            if (!event.data || !event.data.type) {
                return;
            }

            const { type, lat, lon } = event.data;

            if (type === 'MAP_READY') {
                mapReady = true;
                console.log('[Parent] Map is ready.');
            }

            if (type === 'MAP_CLICK') {
                console.log('[Parent] Received map click. Updating coordinates.');
                latInput.value = lat.toFixed(6);
                lonInput.value = lon.toFixed(6);
            }
        });
        
        // 3. LRI ë¶„ì„ API í˜¸ì¶œ í•¨ìˆ˜
        async function requestLriAnalysis(lat, lon) {
            resultBox.innerHTML = `â³ ${lat.toFixed(4)}, ${lon.toFixed(4)} ì¢Œí‘œ ë¶„ì„ ì¤‘...`;

            try {
                const uamType = uamTypeSelect.value;
                const wingType = wingTypeSelect.value;

                const response = await fetch(`${API_BASE_URL}/api/calculate_lri`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        lat, 
                        lon,
                        uam_type: uamType,
                        wing_type: wingType
                    })
                });

                if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);
                
                const data = await response.json();
                await displayResults(data);
                
                // Reload map with marker, choropleth, and the final grade
                console.log('[Parent] Analysis complete. Reloading map to add marker and choropleth.');
                await loadMap(lat, lon, data.LRI, data.Grade);

            } catch (error) {
                resultBox.innerHTML = `âŒ API í˜¸ì¶œ ì˜¤ë¥˜: ${error.message}. Python ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.`;
            }
        }

        // 4. ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        async function displayResults(data) {
            let gradeClass = '';
            const gradeText = data.Grade.toUpperCase();

            if (gradeText.includes('HARD STOP')) {
                gradeClass = 'grade-red';
            } else if (gradeText.includes('SEVERE')) {
                gradeClass = 'grade-yellow';
            } else if (gradeText.includes('WARNING')) {
                gradeClass = 'grade-blue';
            } else { // VERY GOOD
                gradeClass = 'grade-green';
            }
            
            let gradeHtml = `<span class="grade-tag ${gradeClass}">${data.Grade} (LRI: ${data.LRI})</span>`;
            if (data.HardStop) {
                gradeHtml = `<span class="grade-tag ${gradeClass} hard-stop">ğŸ›‘ ${data.Grade} (LRI: ${data.LRI})</span>`;
            }

            const evidence = data.Evidence || {};
            const evidenceKeys = Object.keys(evidence);

            function findEvidence(variants) {
                for (const v of variants) {
                    const key = evidenceKeys.find(k => k && k.toLowerCase().includes(v.toLowerCase()));
                    if (key) return evidence[key];
                }
                return {};
            }

            const weatherEvidence = findEvidence(['weather', 'ì²œë¦¬', 'cheollian', 'ì²œë¦¬ì•ˆ']);
            const navEvidence = findEvidence(['navigation', 'kass', 'nav', 'ì°©ë¥™ ê³ ê°', 'KASS']);
            const terrainEvidence = findEvidence(['terrain', 'ì•„ë¦¬ë‘', 'dem', 'ì§€í˜•']);

            const alpha_cloud = (weatherEvidence && weatherEvidence.alpha_cloud) ? weatherEvidence.alpha_cloud : 'N/A';
            const actual_visibility = (weatherEvidence && weatherEvidence.actual_visibility) ? weatherEvidence.actual_visibility : 'N/A';
            const hpl = (navEvidence && navEvidence.HPL) ? navEvidence.HPL : 'N/A';
            const vpl = (navEvidence && navEvidence.VPL) ? navEvidence.VPL : 'N/A';
            const alpha_terrain = (terrainEvidence && terrainEvidence.alpha_terrain) ? terrainEvidence.alpha_terrain : 'N/A';

            resultBox.innerHTML = `
                <h3>âœ… ë¶„ì„ ê²°ê³¼ (${data.location})</h3>
                <p><strong>ì°©ë¥™ ìœ„í—˜ë„ (LRI)</strong> </p>
                <p>${gradeHtml}</p>
                
                <hr>
                <p><strong>ë¶„ì„ ê·¼ê±° (Evidence)</strong></p>
                <p><strong>ì²œë¦¬ì•ˆ ë‚ ì”¨ ì •ë³´: êµ¬ë¦„ ì´ë™ (Weather)</strong></p>
                <p>W-Score: ${data.W_score ?? 'N/A'}, êµ¬ë¦„ ê°ì‡ : ${alpha_cloud}, ì‹œì •: ${actual_visibility}</p>

                <p><strong>KASS ì •ë³´: ì°©ë¥™ ê³ ê° HPL, ì•™ê° VPL (Navigation)</strong></p>
                <p>N-Score: ${data.N_score ?? 'N/A'}, HPL: ${hpl}m, VPL: ${vpl}m</p>

                <p><strong>ì•„ë¦¬ë‘ ì •ë³´: ì°©ë¥™ ì§€í˜• (Terrain)</strong></p>
                <p>T-Score: ${data.T_score ?? 'N/A'}, ì§€í˜• ë³µì¡ë„: ${alpha_terrain}</p>
            `;

            // ì§€ë„ì— LRI ì‹œê°í™” ìš”ì²­
            const [latStr, lonStr] = data.location.replace(/Lat: |Lon: /g, '').split(', ');
            // await sendLriToMap(latStr, lonStr, data.LRI);
        }

        // 5. ë§µ ë¡œë“œ/ë¦¬ë¡œë“œ í•¨ìˆ˜
        async function loadMap(lat = null, lon = null, lri = null, grade = null) {
            console.log('[Parent] loadMap function called with params:', { lat, lon, lri, grade });
            try {
                let url = `${API_BASE_URL}/api/map`;
                const params = new URLSearchParams();
                
                if (lat !== null) params.append('lat', lat);
                if (lon !== null) params.append('lon', lon);
                if (lri !== null) params.append('lri', lri);
                if (grade !== null) params.append('grade', grade);
                
                const queryString = params.toString();
                if (queryString) {
                    url += '?' + queryString;
                }
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to load map: ${response.status}`);
                
                const mapHtml = await response.text();
                mapFrame.srcdoc = mapHtml;
                mapReady = false; // Wait for new map to signal ready
            } catch (error) {
                console.error("Error loading map:", error);
                resultBox.innerHTML = "ë§µ ë¡œë”© ì‹¤íŒ¨. ë°±ì—”ë“œ ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            }
        }

        // Initial map load
        loadMap();
    </script>
</body>
</html>