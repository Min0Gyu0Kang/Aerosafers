<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>LRI ì—”ì§„ í”„ë¡œí† íƒ€ì… ë°ëª¨</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; margin: 0; display: flex; height: 100vh; }
        #left-panel { width: 350px; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; }
        #map-container { flex-grow: 1; height: 100%; }
        #map-area { width: 100%; height: 100%; background-color: #e0e0e0; border: none; }
        #result-box { margin-top: 20px; padding: 15px; border: 2px solid #ccc; white-space: pre-wrap; background-color: #f9f9f9; }
        h2, h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"] { width: calc(100% - 10px); padding: 5px; margin-top: 5px; }
        button { width: 100%; padding: 10px; margin-top: 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        .grade-red { color: white; background-color: red; padding: 5px; border-radius: 4px; font-weight: bold; }
        .grade-yellow { color: black; background-color: yellow; padding: 5px; border-radius: 4px; font-weight: bold; }
        .grade-green { color: white; background-color: green; padding: 5px; border-radius: 4px; font-weight: bold; }
        .hard-stop { border: 3px solid black; animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="left-panel">
        <h2>LRI ë¶„ì„ ì—”ì§„</h2>
        
        <div>
            <label for="lat-input">ìœ„ë„ (Latitude):</label>
            <input type="text" id="lat-input" placeholder="ì˜ˆ: 37.45">

            <label for="lon-input">ê²½ë„ (Longitude):</label>
            <input type="text" id="lon-input" placeholder="ì˜ˆ: 126.78">

            <button id="submit-coords">ì¢Œí‘œë¡œ ë¶„ì„</button>
        </div>

        <div id="result-box">
            ë§µì„ í´ë¦­í•˜ê±°ë‚˜ ì¢Œí‘œë¥¼ ì…ë ¥í•˜ì—¬ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.
        </div>
    </div>

    <div id="map-container">
        <iframe id="map-area" title="Interactive Map"></iframe>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Change this URL to your EC2 backend's public address
        const API_BASE_URL = 'http://52.78.12.152:8000';
        // -------------------

        const latInput = document.getElementById('lat-input');
        const lonInput = document.getElementById('lon-input');
        const submitButton = document.getElementById('submit-coords');
        const resultBox = document.getElementById('result-box');
        const mapFrame = document.getElementById("map-area");

        // 1. ì¢Œí‘œ ì…ë ¥ í›„ ë¶„ì„ ìš”ì²­
        submitButton.addEventListener('click', () => {
            const lat = parseFloat(latInput.value);
            const lon = parseFloat(lonInput.value);

            if (!isNaN(lat) && !isNaN(lon)) {
                // ì§€ë„ì— ë§ˆì»¤ í‘œì‹œ ìš”ì²­
                mapFrame.contentWindow.postMessage({ type: 'ADD_MARKER', lat, lon }, '*');
                // LRI ë¶„ì„ ìš”ì²­
                requestLriAnalysis(lat, lon);
            } else {
                alert('ìœ íš¨í•œ ìœ„ë„ì™€ ê²½ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            }
        });

        // 2. ì§€ë„ í´ë¦­ ì‹œ ì¢Œí‘œ ë°›ì•„ì˜¤ê¸°
        window.addEventListener('message', event => {
            // ë©”ì‹œì§€ê°€ ë§µ iframeìœ¼ë¡œë¶€í„° ì˜¨ ê²ƒì¸ì§€ í™•ì¸
            if (event.source !== mapFrame.contentWindow) {
                return;
            }

            const { type, lat, lon } = event.data;
            if (type === 'MAP_CLICK') {
                latInput.value = lat.toFixed(6);
                lonInput.value = lon.toFixed(6);
                requestLriAnalysis(lat, lon);
            }
        });

        // 3. LRI ë¶„ì„ API í˜¸ì¶œ í•¨ìˆ˜
        async function requestLriAnalysis(lat, lon) {
            resultBox.innerHTML = `â³ ${lat.toFixed(4)}, ${lon.toFixed(4)} ì¢Œí‘œ ë¶„ì„ ì¤‘...`;

            try {
                const response = await fetch(`${API_BASE_URL}/api/calculate_lri`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat, lon }) // 'scenario' is no longer needed
                });

                if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);
                
                const data = await response.json();
                displayResults(data);

            } catch (error) {
                resultBox.innerHTML = `âŒ API í˜¸ì¶œ ì˜¤ë¥˜: ${error.message}. Python ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.`;
            }
        }

        // 4. ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function displayResults(data) {
            let gradeClass = '';
            if (data.Grade.includes('RED')) gradeClass = 'grade-red';
            else if (data.Grade.includes('YELLOW')) gradeClass = 'grade-yellow';
            else gradeClass = 'grade-green';
            
            let gradeHtml = `<span class="${gradeClass}">${data.Grade} (LRI: ${data.LRI})</span>`;
            if (data.HardStop) {
                gradeHtml = `<span class="${gradeClass} hard-stop">ğŸ›‘ ${data.Grade} (LRI: ${data.LRI})</span>`;
            }

            resultBox.innerHTML = `
                <h3>âœ… ë¶„ì„ ê²°ê³¼ (${data.location})</h3>
                <p><strong>ìµœì¢… ë“±ê¸‰:</strong> ${gradeHtml}</p>
                <p><strong>3ëŒ€ ìœ„í—˜ ìš”ì†Œ ì ìˆ˜:</strong> W: ${data.W_score} / N: ${data.N_score} / T: ${data.T_score}</p>
                <h4>ğŸ“ ê·¼ê±° ë°ì´í„°</h4>
                <ul>
                    ${data.Evidence.map(e => `<li>${e}</li>`).join('')}
                </ul>
            `;
        }

        // 5. ì´ˆê¸° ë§µ ë¡œë“œ
        async function loadMap() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/map`);
                if (!response.ok) throw new Error(`Failed to load map: ${response.status}`);
                
                const mapHtml = await response.text();
                mapFrame.srcdoc = mapHtml; // srcdocì„ ì‚¬ìš©í•´ HTML ì§ì ‘ ì‚½ì…
            } catch (error) {
                console.error("Error loading map:", error);
                resultBox.innerHTML = "ë§µ ë¡œë”© ì‹¤íŒ¨. ë°±ì—”ë“œ ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            }
        }

        loadMap();
    </script>
</body>
</html>